<!DOCTYPE html>

<HTML><head><TITLE>Manpage of docs::api::Apache2::PerlSections</TITLE>
<meta charset="utf-8">
<link rel="stylesheet" href="/css/main.css" type="text/css">
</head>
<body>
 <header class="site-header">
 <div class="wrap"> <div class="site-title"><a href="/manpages/index.html">linux manpages</a></div>
 <div class="site-description">{"type":"documentation"}</div>
 </div>
 </header>
 <div class="page-content"><div class="wrap">
<H1>docs::api::Apache2::PerlSections</H1>
Section: User Contributed Perl Documentation (3)<BR>Updated: 2007-11-12<BR><A HREF="#index">Index</A>
<A HREF="/manpages/index.html">Return to Main Contents</A><HR>






<A NAME="lbAB">&nbsp;</A>
<H2>NAME</H2>

Apache2::PerlSections - write Apache configuration files in Perl
<A NAME="lbAC">&nbsp;</A>
<H2>Synopsis</H2>

<A NAME="ixAAC"></A>


<PRE>
  &lt;Perl&gt;
  @PerlModule = qw(Mail::Send Devel::Peek);
  
  #run the server as whoever starts it
  $User  = getpwuid(&gt;) || &gt;;
  $Group = getgrgid()) || );
  
  $ServerAdmin = $User;
  
  &lt;/Perl&gt;

</PRE>


<A NAME="lbAD">&nbsp;</A>
<H2>Description</H2>

<A NAME="ixAAD"></A>
With <TT>&quot;&lt;Perl&gt;&quot;</TT>...<TT>&quot;&lt;/Perl&gt;&quot;</TT> sections, it is possible
to configure your server entirely in Perl.
<P>

<TT>&quot;&lt;Perl&gt;&quot;</TT> sections can contain <I>any</I> and as much Perl code as
you wish. These sections are compiled into a special package whose
symbol table mod_perl can then walk and grind the names and values of
Perl variables/structures through the Apache core configuration gears.
<P>

Block sections such as <TT>&quot;&lt;Location&gt;&quot;</TT>..<TT>&quot;&lt;/Location&gt;&quot;</TT>
are represented in a <TT>%Location</TT> hash, e.g.:
<P>



<PRE>
  &lt;Perl&gt;
  $Location{&quot;/~dougm/&quot;} = {
    AuthUserFile   =&gt; '/tmp/htpasswd',
    AuthType       =&gt; 'Basic',
    AuthName       =&gt; 'test',
    DirectoryIndex =&gt; [qw(index.html index.htm)],
    Limit          =&gt; {
        &quot;GET POST&quot;    =&gt; {
            require =&gt; 'user dougm',
        }
    },
  };
  &lt;/Perl&gt;

</PRE>


<P>

If an Apache directive can take two or three arguments you may push
strings (the lowest number of arguments will be shifted off the
<TT>@list</TT>) or use an array reference to handle any number greater than
the minimum for that directive:
<P>



<PRE>
  push @Redirect, &quot;/foo&quot;, &quot;<A HREF="http://www.foo.com/">http://www.foo.com/</A>&quot;;
  
  push @Redirect, &quot;/imdb&quot;, &quot;<A HREF="http://www.imdb.com/">http://www.imdb.com/</A>&quot;;
  
  push @Redirect, [qw(temp &quot;/here&quot; &quot;<A HREF="http://www.there.com">http://www.there.com</A>&quot;)];

</PRE>


<P>

Other section counterparts include <TT>%VirtualHost</TT>, <TT>%Directory</TT> and
<TT>%Files</TT>.
<P>

To pass all environment variables to the children with a single
configuration directive, rather than listing each one via <TT>&quot;PassEnv&quot;</TT>
or <TT>&quot;PerlPassEnv&quot;</TT>, a <TT>&quot;&lt;Perl&gt;&quot;</TT> section could read in a file and:
<P>



<PRE>
  push @PerlPassEnv, [$key =&gt; $val];

</PRE>


<P>

or
<P>



<PRE>
  Apache2-&gt;httpd_conf(&quot;PerlPassEnv $key $val&quot;);

</PRE>


<P>

These are somewhat simple examples, but they should give you the basic
idea. You can mix in any Perl code you desire. See <I>eg/httpd.conf.pl</I>
and <I>eg/perl_sections.txt</I> in the mod_perl distribution for more
examples.
<P>

Assume that you have a cluster of machines with similar configurations
and only small distinctions between them: ideally you would want to
maintain a single configuration file, but because the configurations
aren't <I>exactly</I> the same (e.g. the <TT>&quot;ServerName&quot;</TT> directive) it's not
quite that simple.
<P>

<TT>&quot;&lt;Perl&gt;&quot;</TT> sections come to rescue. Now you have a single
configuration file and the full power of Perl to tweak the local
configuration. For example to solve the problem of the <TT>&quot;ServerName&quot;</TT>
directive you might have this <TT>&quot;&lt;Perl&gt;&quot;</TT> section:
<P>



<PRE>
  &lt;Perl&gt;
  $ServerName = `hostname`;
  &lt;/Perl&gt;

</PRE>


<P>

For example if you want to allow personal directories on all machines
except the ones whose names start with <I>secure</I>:
<P>



<PRE>
  &lt;Perl&gt;
  $ServerName = `hostname`;
  if ($ServerName !~ /^secure/) {
      $UserDir = &quot;public.html&quot;;
  }
  else {
      $UserDir = &quot;DISABLED&quot;;
  }
  &lt;/Perl&gt;

</PRE>


<A NAME="lbAE">&nbsp;</A>
<H2>API</H2>

<A NAME="ixAAE"></A>
<TT>&quot;Apache2::PerlSections&quot;</TT> provides the following functions and/or methods:
<A NAME="lbAF">&nbsp;</A>
<H3>server</H3>



<A NAME="ixAAF"></A>
Get the current server's object for the &lt;Perl&gt; section
<P>



<PRE>
  &lt;Perl&gt;
    $s = Apache2::PerlSections-&gt;server();
  &lt;/Perl&gt;

</PRE>


<DL COMPACT>
<DT>obj: Apache2::PerlSections (class name)<DD>


<A NAME="ixAAG"></A>

<DT>ret: $s ( Apache2::ServerRec object )<DD>


<A NAME="ixAAH"></A>
<DT>since: 2.0.03<DD>
<A NAME="ixAAI"></A>

</DL>
<A NAME="lbAG">&nbsp;</A>
<H2>@PerlConfig and $PerlConfig</H2>



<A NAME="ixAAJ"></A>
This array and scalar can be used to introduce literal configuration
into the apache configuration. For example:
<P>



<PRE>
  push @PerlConfig, 'Alias /foo /bar';

</PRE>


<P>

Or:
<BR>&nbsp;&nbsp;<TT>$PerlConfig</TT>&nbsp;.=&nbsp;``Alias&nbsp;/foo&nbsp;/bar\n'';
<P>

See also
<TT>&quot;$r-&gt;add_config&quot;</TT>
<A NAME="lbAH">&nbsp;</A>
<H2>Configuration Variables</H2>

<A NAME="ixAAK"></A>
There are a few variables that can be set to change the default
behaviour of <TT>&quot;&lt;Perl&gt;&quot;</TT> sections.
<A NAME="lbAI">&nbsp;</A>
<H3>$Apache2::PerlSections::Save</H3>



<A NAME="ixAAL"></A>
Each <TT>&quot;&lt;Perl&gt;&quot;</TT> section is evaluated in its unique namespace,
by default residing in a sub-namespace of <TT>&quot;Apache2::ReadConfig::&quot;</TT>,
therefore any local variables will end up in that namespace. For
example if a <TT>&quot;&lt;Perl&gt;&quot;</TT> section happened to be in file
<I>/tmp/httpd.conf</I> starting on line 20, the namespace:
<TT>&quot;Apache2::ReadConfig::tmp::httpd_conf::line_20&quot;</TT> will be used. Now if
it had:
<P>



<PRE>
  &lt;Perl&gt;
    $foo     = 5;
    my $bar  = 6;
    $My::tar = 7;
  &lt;/Perl&gt;

</PRE>


<P>

The local global variable <TT>$foo</TT> becomes
<TT>$Apache2::ReadConfig::tmp::httpd_conf::line_20::foo</TT>, the other
variable remain where they are.
<P>

By default, the namespace in which <TT>&quot;&lt;Perl&gt;&quot;</TT> sections are
evaluated is cleared after each block closes. In our example nuking
<TT>$Apache2::ReadConfig::tmp::httpd_conf::line_20::foo</TT>, leaving the
rest untouched.
<P>

By setting <TT>$Apache2::PerlSections::Save</TT> to a true value, the content
of those namespaces will be preserved and will be available for
inspection by <TT>&quot;Apache2::Status&quot;</TT> and
<TT>&quot;Apache2::PerlSections-&gt;dump&quot;</TT>
In our example <TT>$Apache2::ReadConfig::tmp::httpd_conf::line_20::foo</TT>
will still be accessible from other perl code, after the
<TT>&quot;&lt;Perl&gt;&quot;</TT> section was parsed.
<A NAME="lbAJ">&nbsp;</A>
<H2>PerlSections Dumping</H2>

<A NAME="ixAAM"></A>
<A NAME="lbAK">&nbsp;</A>
<H3>Apache2::PerlSections-&gt;dump</H3>



<A NAME="ixAAN"></A>
This method will dump out all the configuration variables mod_perl
will be feeding to the apache config gears. The output is suitable to
read back in via <TT>&quot;eval&quot;</TT>.
<P>



<PRE>
  my $dump = Apache2::PerlSections-&gt;dump;

</PRE>


<DL COMPACT>
<DT>ret: $dump ( string / undef )<DD>


<A NAME="ixAAO"></A>
A string dump of all the Perl code encountered in &lt;Perl&gt; blocks,
suitable to be read back via <TT>&quot;eval&quot;</TT>
</DL>
<P>

For example:
<P>



<PRE>
  &lt;Perl&gt;
  
  $Apache2::PerlSections::Save = 1;
  
  $Listen = 8529;
  
  $Location{&quot;/perl&quot;} = {
     SetHandler =&gt; &quot;perl-script&quot;,
     PerlHandler =&gt; &quot;ModPerl::Registry&quot;,
     Options =&gt; &quot;ExecCGI&quot;,
  };
  
  @DirectoryIndex = qw(index.htm index.html);
  
  $VirtualHost{&quot;<A HREF="http://www.foo.com">www.foo.com</A>&quot;} = {
     DocumentRoot =&gt; &quot;/tmp/docs&quot;,
     ErrorLog =&gt; &quot;/dev/null&quot;,
     Location =&gt; {
       &quot;/&quot; =&gt; {
         Allowoverride =&gt; 'All',
         Order =&gt; 'deny,allow',
         Deny  =&gt; 'from all',
         Allow =&gt; 'from foo.com',
       },
     },
  };
  &lt;/Perl&gt;
  
  &lt;Perl&gt;
  print Apache2::PerlSections-&gt;dump;
  &lt;/Perl&gt;

</PRE>


<P>

This will print something like this:
<P>



<PRE>
  $Listen = 8529;
  
  @DirectoryIndex = (
    'index.htm',
    'index.html'
  );
  
  $Location{'/perl'} = (
      PerlHandler =&gt; 'Apache2::Registry',
      SetHandler =&gt; 'perl-script',
      Options =&gt; 'ExecCGI'
  );
  
  $VirtualHost{'<A HREF="http://www.foo.com">www.foo.com</A>'} = (
      Location =&gt; {
        '/' =&gt; {
          Deny =&gt; 'from all',
          Order =&gt; 'deny,allow',
          Allow =&gt; 'from foo.com',
          Allowoverride =&gt; 'All'
        }
      },
      DocumentRoot =&gt; '/tmp/docs',
      ErrorLog =&gt; '/dev/null'
  );
  
  1;
  __END__

</PRE>


<P>

It is important to put the call to <TT>&quot;dump&quot;</TT> in it's own <TT>&quot;&lt;Perl&gt;&quot;</TT>
section, otherwise the content of the current <TT>&quot;&lt;Perl&gt;&quot;</TT> section
will not be dumped.
<A NAME="lbAL">&nbsp;</A>
<H3>Apache2::PerlSections-&gt;store</H3>



<A NAME="ixAAP"></A>
This method will call the <TT>&quot;dump&quot;</TT> method, writing the output
to a file, suitable to be pulled in via <TT>&quot;require&quot;</TT> or <TT>&quot;do&quot;</TT>.
<P>



<PRE>
  Apache2::PerlSections-&gt;store($filename);

</PRE>


<DL COMPACT>
<DT>arg1: $filename (string)<DD>


<A NAME="ixAAQ"></A>
The filename to save the dump output to
<DT>ret: no return value<DD>
<A NAME="ixAAR"></A>
</DL>
<A NAME="lbAM">&nbsp;</A>
<H2>Advanced API</H2>

<A NAME="ixAAS"></A>
mod_perl 2.0 now introduces the same general concept of handlers to
<TT>&quot;&lt;Perl&gt;&quot;</TT> sections.  Apache2::PerlSections simply being the
default handler for them.
<P>

To specify a different handler for a given perl section, an extra
handler argument must be given to the section:
<P>



<PRE>
  &lt;Perl handler=&quot;My::PerlSection::Handler&quot; somearg=&quot;test1&quot;&gt;
    $foo = 1;
    $bar = 2;
  &lt;/Perl&gt;

</PRE>


<P>

And in My/PerlSection/Handler.pm:
<P>



<PRE>
  sub My::Handler::handler : handler {
      my ($self, $parms, $args) = @_;
      #do your thing!
  }

</PRE>


<P>

So, when that given <TT>&quot;&lt;Perl&gt;&quot;</TT> block in encountered, the code
within will first be evaluated, then the handler routine will be
invoked with 3 arguments:
<DL COMPACT>
<DT>arg1: $self<DD>


<A NAME="ixAAT"></A>
self-explanatory
<DT>arg2: $parms ( Apache2::CmdParms )<DD>


<A NAME="ixAAU"></A>
<TT>$parms</TT> is specific for the current Container, for example, you
might want to call <TT>&quot;$parms-&gt;server()&quot;</TT> to get the current server.
<DT>arg3: $args ( APR::Table object)<DD>


<A NAME="ixAAV"></A>
the table object of the section arguments. The 2 guaranteed ones will
be:


<P>




<PRE>
  $args-&gt;{'handler'} = 'My::PerlSection::Handler';
  $args-&gt;{'package'} = 'Apache2::ReadConfig';

</PRE>




<P>


Other <TT>&quot;name=&quot;value&quot;&quot;</TT> pairs given on the <TT>&quot;&lt;Perl&gt;&quot;</TT> line will
also be included.
</DL>
<P>

At this point, it's up to the handler routing to inspect the namespace
of the <TT>$args</TT>-&gt;{'package'} and chooses what to do.
<P>

The most likely thing to do is to feed configuration data back into
apache. To do that, use Apache2::Server-&gt;add_config(``directive''),
for example:
<P>



<PRE>
  $parms-&gt;server-&gt;add_config(&quot;Alias /foo /bar&quot;);

</PRE>


<P>

Would create a new alias. The source code of <TT>&quot;Apache2::PerlSections&quot;</TT>
is a good place to look for a practical example.
<A NAME="lbAN">&nbsp;</A>
<H2>Verifying &lt;Perl&gt; Sections</H2>



<A NAME="ixAAW"></A>
If the <TT>&quot;&lt;Perl&gt;&quot;</TT> sections include no code requiring a running
mod_perl, it is possible to check those from the command line. But the
following trick should be used:
<P>



<PRE>
  # file: httpd.conf
  &lt;Perl&gt;
  #!perl
  
  # ... code here ...
  
  __END__
  &lt;/Perl&gt;

</PRE>


<P>

Now you can run:
<P>



<PRE>
  % perl -c httpd.conf

</PRE>


<A NAME="lbAO">&nbsp;</A>
<H2>Bugs</H2>

<A NAME="ixAAX"></A>
<A NAME="lbAP">&nbsp;</A>
<H3>&lt;Perl&gt; directive missing closing '&gt;'</H3>

<A NAME="ixAAY"></A>
httpd-2.0.47 had a bug in the configuration parser which caused the
startup failure with the following error:
<P>



<PRE>
  Starting httpd:
  Syntax error on line ... of /etc/httpd/conf/httpd.conf:
  &lt;Perl&gt; directive missing closing '&gt;'     [FAILED]

</PRE>


<P>

This has been fixed in httpd-2.0.48. If you can't upgrade to this or a
higher version, please add a space before the closing '&gt;' of the
opening tag as a workaround. So if you had:
<P>



<PRE>
  &lt;Perl&gt;
  # some code
  &lt;/Perl&gt;

</PRE>


<P>

change it to be:
<P>



<PRE>
  &lt;Perl &gt;
  # some code
  &lt;/Perl&gt;

</PRE>


<A NAME="lbAQ">&nbsp;</A>
<H3>&lt;Perl&gt;[...]&gt; was not closed.</H3>

<A NAME="ixAAZ"></A>
On encountering a one-line &lt;Perl&gt; block, 
httpd's configuration parser will cause a startup
failure with an error similar to this one:
<P>



<PRE>
  Starting httpd:
  Syntax error on line ... of /etc/httpd/conf/httpd.conf:
  &lt;Perl&gt;use&gt; was not closed.

</PRE>


<P>

If you have written a simple one-line &lt;Perl&gt;
section like this one :
<P>



<PRE>
  &lt;Perl&gt;use Apache::DBI;&lt;/Perl&gt;

</PRE>


<P>

change it to be:
<P>



<PRE>
   &lt;Perl&gt;
   use Apache::DBI;
   &lt;/Perl&gt;

</PRE>


<P>

This is caused by a limitation of httpd's configuration
parser and is not likely to be changed to allow one-line
block like the example above. Use multi-line blocks instead.
<A NAME="lbAR">&nbsp;</A>
<H2>See Also</H2>

<A NAME="ixABA"></A>
mod_perl 2.0 documentation.
<A NAME="lbAS">&nbsp;</A>
<H2>Copyright</H2>

<A NAME="ixABB"></A>
mod_perl 2.0 and its core modules are copyrighted under
The Apache Software License, Version 2.0.
<A NAME="lbAT">&nbsp;</A>
<H2>Authors</H2>

<A NAME="ixABC"></A>
The mod_perl development team and numerous
contributors.
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">NAME</A><DD>
<DT><A HREF="#lbAC">Synopsis</A><DD>
<DT><A HREF="#lbAD">Description</A><DD>
<DT><A HREF="#lbAE">API</A><DD>
<DL>
<DT><A HREF="#lbAF">server</A><DD>
</DL>
<DT><A HREF="#lbAG">@PerlConfig and $PerlConfig</A><DD>
<DT><A HREF="#lbAH">Configuration Variables</A><DD>
<DL>
<DT><A HREF="#lbAI">$Apache2::PerlSections::Save</A><DD>
</DL>
<DT><A HREF="#lbAJ">PerlSections Dumping</A><DD>
<DL>
<DT><A HREF="#lbAK">Apache2::PerlSections-&gt;dump</A><DD>
<DT><A HREF="#lbAL">Apache2::PerlSections-&gt;store</A><DD>
</DL>
<DT><A HREF="#lbAM">Advanced API</A><DD>
<DT><A HREF="#lbAN">Verifying &lt;Perl&gt; Sections</A><DD>
<DT><A HREF="#lbAO">Bugs</A><DD>
<DL>
<DT><A HREF="#lbAP">&lt;Perl&gt; directive missing closing '&gt;'</A><DD>
<DT><A HREF="#lbAQ">&lt;Perl&gt;[...]&gt; was not closed.</A><DD>
</DL>
<DT><A HREF="#lbAR">See Also</A><DD>
<DT><A HREF="#lbAS">Copyright</A><DD>
<DT><A HREF="#lbAT">Authors</A><DD>
</DL>
<HR>
This document was created by
<A HREF="/manpages/index.html">man2html</A>,
using the manual pages.<BR>
Time: 05:33:11 GMT, December 24, 2015
</div></div>
</body>
</HTML>
