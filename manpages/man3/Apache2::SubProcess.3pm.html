<!DOCTYPE html>

<HTML><head><TITLE>Manpage of docs::api::Apache2::SubProcess</TITLE>
<meta charset="utf-8">
<link rel="stylesheet" href="/css/main.css" type="text/css">
</head>
<body>
 <header class="site-header">
 <div class="wrap"> <div class="site-title"><a href="/manpages/index.html">linux man pages</a></div>
 <div class="site-description">{"type":"programming"}</div>
 </div>
 </header>
 <div class="page-content">
<H1>docs::api::Apache2::SubProcess</H1>
Section: User Contributed Perl Documentation (3)<BR>Updated: 2007-11-12<BR><A HREF="#index">Index</A>
<A HREF="/manpages/index.html">Return to Main Contents</A><HR>






<A NAME="lbAB">&nbsp;</A>
<H2>NAME</H2>

Apache2::SubProcess -- Executing SubProcesses under mod_perl
<A NAME="lbAC">&nbsp;</A>
<H2>Synopsis</H2>

<A NAME="ixAAC"></A>


<PRE>
  use Apache2::SubProcess ();
  
  use Config;
  use constant PERLIO_IS_ENABLED =&gt; $Config{useperlio};
  
  # pass @ARGV / read from the process
  $command = &quot;/tmp/argv.pl&quot;;
  @argv = qw(foo bar);
  $out_fh = $r-&gt;spawn_proc_prog($command, \@argv);
  $output = read_data($out_fh);
  
  # pass environment / read from the process
  $command = &quot;/tmp/env.pl&quot;;
  $r-&gt;subprocess_env-&gt;set(foo =&gt; &quot;bar&quot;);
  $out_fh = $r-&gt;spawn_proc_prog($command);
  $output = read_data($out_fh);
  
  # write to/read from the process
  $command = &quot;/tmp/in_out_err.pl&quot;;
  ($in_fh, $out_fh, $err_fh) = $r-&gt;spawn_proc_prog($command);
  print $in_fh &quot;hello\n&quot;;
  $output = read_data($out_fh);
  $error  = read_data($err_fh);
  
  # helper function to work w/ and w/o perlio-enabled Perl
  sub read_data {
      my ($fh) = @_;
      my $data;
      if (PERLIO_IS_ENABLED || IO::Select-&gt;new($fh)-&gt;can_read(10)) {
          $data = &lt;$fh&gt;;
      }
      return defined $data ? $data : '';
  }
  
  # pass @ARGV but don't ask for any communication channels
  $command = &quot;/tmp/argv.pl&quot;;
  @argv = qw(foo bar);
  $r-&gt;spawn_proc_prog($command, \@argv);

</PRE>


<A NAME="lbAD">&nbsp;</A>
<H2>Description</H2>

<A NAME="ixAAD"></A>
<TT>&quot;Apache2::SubProcess&quot;</TT> provides the Perl <FONT SIZE="-1">API</FONT> for running and
communicating with processes spawned from mod_perl handlers.
<P>

At the moment it's possible to spawn only external program in a new
process. It's possible to provide other interfaces, e.g. executing a
sub-routine reference (via <TT>&quot;B::Deparse&quot;</TT>) and may be spawn a new
program in a thread (since the <FONT SIZE="-1">APR</FONT> api includes <FONT SIZE="-1">API</FONT> for spawning
threads, e.g. that's how it's running mod_cgi on win32).
<A NAME="lbAE">&nbsp;</A>
<H2>API</H2>

<A NAME="ixAAE"></A>
<A NAME="lbAF">&nbsp;</A>
<H3>spawn_proc_prog</H3>



<A NAME="ixAAF"></A>
Spawn a sub-process and return <FONT SIZE="-1">STD</FONT> communication pipes:
<P>



<PRE>
                               $r-&gt;spawn_proc_prog($command);
                               $r-&gt;spawn_proc_prog($command, \@argv);
  $out_fh                    = $r-&gt;spawn_proc_prog($command);
  $out_fh                    = $r-&gt;spawn_proc_prog($command, \@argv);
  ($in_fh, $out_fh, $err_fh) = $r-&gt;spawn_proc_prog($command);
  ($in_fh, $out_fh, $err_fh) = $r-&gt;spawn_proc_prog($command, \@argv);

</PRE>


<DL COMPACT>
<DT>obj: $r ( Apache2::RequestRec object )<DD>


<A NAME="ixAAG"></A>

<DT>arg1: $command ( string )<DD>


<A NAME="ixAAH"></A>

The command to be <TT>&quot;$exec()&quot;</TT>'ed.
<DT>opt arg2: \@argv ( <FONT SIZE="-1">ARRAY</FONT> ref )<DD>


<A NAME="ixAAI"></A>
A reference to an array of arguments to be passed to the process as
the process' <TT>&quot;ARGV&quot;</TT>.
<DT>ret: ...<DD>
<A NAME="ixAAJ"></A>
In <FONT SIZE="-1">VOID</FONT> context returns no filehandles (all std streams to the spawned
process are closed).


<P>


In <FONT SIZE="-1">SCALAR</FONT> context returns the output filehandle of the spawned process
(the in and err std streams to the spawned process are closed).


<P>


In <FONT SIZE="-1">LIST</FONT> context returns the input, outpur and error filehandles of the
spawned process.
<DT>since: 2.0.00<DD>
<A NAME="ixAAK"></A>
</DL>
<P>

It's possible to pass environment variables as well, by calling:
<P>



<PRE>
  $r-&gt;subprocess_env-&gt;set($key =&gt; $value);

</PRE>


<P>

before spawning the subprocess.
<P>

There is an issue with reading from the read filehandle (<TT>$in_fh</TT>)):
<P>

A pipe filehandle returned under perlio-disabled Perl needs to call
<I>select()</I> if the other end is not fast enough to send the data, since
the read is non-blocking.
<P>

A pipe filehandle returned under perlio-enabled Perl on the other hand
does the <I>select()</I> internally, because it's really a filehandle opened
via <TT>&quot;:APR&quot;</TT> layer, which internally uses <FONT SIZE="-1">APR</FONT> to communicate with the
pipe. The way <FONT SIZE="-1">APR</FONT> is implemented Perl's <I>select()</I> cannot be used with
it (mainly because <I>select()</I> wants <I>fileno()</I> and <FONT SIZE="-1">APR</FONT> is a crossplatform
implementation which hides the internal datastructure).
<P>

Therefore to write a portable code, you want to use select for
perlio-disabled Perl and do nothing for perlio-enabled Perl, hence you
can use something similar to the <TT>&quot;read_data()&quot;</TT> wrapper shown in the
Synopsis section.
<P>

Several examples appear in the Synopsis section.
<P>

<TT>&quot;spawn_proc_prog()&quot;</TT> is similar to <TT>&quot;fork()&quot;</TT>, but provides you a
better framework to communicate with that process and handles the
cleanups for you. But that means that just like <TT>&quot;fork()&quot;</TT> it gives you
a different process, so you don't use the current Perl interpreter in
that new process. If you try to use that method or fork to run a
high-performance parallel processing you should look elsewhere. You
could try Perl threads, but they are <B>very</B> expensive to start if you
have a lot of things loaded into memory (since <TT>&quot;perl_clone()&quot;</TT> dups
almost everything in the perl land, but the opcode tree). In the
mod_perl ``paradigm'' this is much more expensive than fork, since
normally most of the time we have lots of perl things loaded into
memory. Most likely the best solution here is to offload the job to
PPerl or some other daemon, with the only added complexity of
communication.
<P>

To spawn a completely independent process, which will be able to run
after Apache has been shutdown and which won't prevent Apache from
restarting (releasing the ports Apache is listening to) call
<I>spawn_proc_prog()</I> in a void context and make the script detach and
close/reopen its communication streams. For example, spawn a process
as:
<P>



<PRE>
  use Apache2::SubProcess ();
  $r-&gt;spawn_proc_prog ('/path/to/detach_script.pl', $args);

</PRE>


<P>

and the <I>/path/to/detach_script.pl</I> contents are:
<P>



<PRE>
  # file:detach_script.pl
  #!/usr/bin/perl -w
  use strict;
  use warnings;
  
  use POSIX 'setsid';
  
  chdir '/'                or die &quot;Can't chdir to /: $!&quot;;
  open STDIN, '/dev/null'  or die &quot;Can't read /dev/null: $!&quot;;
  open STDOUT, '+&gt;&gt;', '/path/to/apache/error_log'
      or die &quot;Can't write to /dev/null: $!&quot;;
  open STDERR, '&gt;&amp;STDOUT'  or die &quot;Can't dup stdout: $!&quot;;
  setsid or die &quot;Can't start a new session: $!&quot;;
  
  # run your code here or call exec to another program

</PRE>


<P>

reopening (or closing) the <FONT SIZE="-1">STD</FONT> streams and called <TT>&quot;setsid()&quot;</TT> makes
sure that the process is now fully detached from Apache and has a life
of its own. <TT>&quot;chdir()&quot;</TT> ensures that no partition is tied, in case you
need to remount it.
<A NAME="lbAG">&nbsp;</A>
<H2>See Also</H2>

<A NAME="ixAAL"></A>
mod_perl 2.0 documentation.
<A NAME="lbAH">&nbsp;</A>
<H2>Copyright</H2>

<A NAME="ixAAM"></A>
mod_perl 2.0 and its core modules are copyrighted under
The Apache Software License, Version 2.0.
<A NAME="lbAI">&nbsp;</A>
<H2>Authors</H2>

<A NAME="ixAAN"></A>
The mod_perl development team and numerous
contributors.
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">NAME</A><DD>
<DT><A HREF="#lbAC">Synopsis</A><DD>
<DT><A HREF="#lbAD">Description</A><DD>
<DT><A HREF="#lbAE">API</A><DD>
<DL>
<DT><A HREF="#lbAF">spawn_proc_prog</A><DD>
</DL>
<DT><A HREF="#lbAG">See Also</A><DD>
<DT><A HREF="#lbAH">Copyright</A><DD>
<DT><A HREF="#lbAI">Authors</A><DD>
</DL>
<HR>
This document was created by
<A HREF="/manpages/index.html">man2html</A>,
using the manual pages.<BR>
Time: 05:33:11 GMT, December 24, 2015
</div></body>
</HTML>
